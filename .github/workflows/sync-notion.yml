name: Sync Notion to Supabase

on:
  schedule:
    # æ¯ 3 å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
    - cron: '0 */3 * * *'
  
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build project
        run: bun run build

      - name: Calculate time range
        id: time
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆUTCï¼‰
          END_TIME=$(date -u +"%Y%m%d%H%M%S")
          
          # è®¡ç®— 3 å°æ—¶å‰çš„æ—¶é—´
          START_TIME=$(date -u -d '3 hours ago' +"%Y%m%d%H%M%S")
          
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "end_time=$END_TIME" >> $GITHUB_OUTPUT
          
          echo "Time range: $START_TIME to $END_TIME"

      - name: Sync Notion databases
        id: sync
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
          CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
          NOTION_DATABASE_IDS: ${{ secrets.NOTION_DATABASE_IDS }}
        run: |
          # ä»ç¯å¢ƒå˜é‡è¯»å–æ•°æ®åº“ ID åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
          # ä¾‹å¦‚ï¼šNOTION_DATABASE_IDS="id1,id2,id3"

          if [ -z "$NOTION_DATABASE_IDS" ]; then
            echo "::error::NOTION_DATABASE_IDS æœªé…ç½®"
            exit 1
          fi

          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
          IFS=',' read -ra DATABASES <<< "$NOTION_DATABASE_IDS"

          START_TIME="${{ steps.time.outputs.start_time }}"
          END_TIME="${{ steps.time.outputs.end_time }}"

          echo "=========================================="
          echo "å¼€å§‹åŒæ­¥ Notion æ•°æ®åº“"
          echo "æ—¶é—´èŒƒå›´: $START_TIME - $END_TIME"
          echo "æ•°æ®åº“æ•°é‡: ${#DATABASES[@]}"
          echo "=========================================="
          echo ""

          # ç»Ÿè®¡å˜é‡
          TOTAL_DBS=${#DATABASES[@]}
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          FAILED_DBS=()
          HAS_UPDATES=false

          # éå†æ‰€æœ‰æ•°æ®åº“
          INDEX=1
          for DB_ID in "${DATABASES[@]}"; do
            # å»é™¤ç©ºæ ¼
            DB_ID=$(echo "$DB_ID" | xargs)

            if [ -z "$DB_ID" ]; then
              continue
            fi

            echo "=========================================="
            echo "[$INDEX/$TOTAL_DBS] åŒæ­¥æ•°æ®åº“"
            echo "æ•°æ®åº“ ID: $DB_ID"
            echo "=========================================="

            # æ‰§è¡ŒåŒæ­¥å‘½ä»¤å¹¶æ•è·è¾“å‡º
            SYNC_OUTPUT=$(bun run dist/index.js sync-updated-page "$DB_ID" "$START_TIME" "$END_TIME" 2>&1)
            SYNC_EXIT_CODE=$?

            echo "$SYNC_OUTPUT"

            if [ $SYNC_EXIT_CODE -eq 0 ]; then
              echo "âœ… æ•°æ®åº“åŒæ­¥æˆåŠŸ"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))

              # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®æ›´æ–°
              if echo "$SYNC_OUTPUT" | grep -q "has_updates::true"; then
                HAS_UPDATES=true
              fi
            else
              echo "âŒ æ•°æ®åº“åŒæ­¥å¤±è´¥"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              FAILED_DBS+=("$DB_ID")
            fi

            echo ""
            INDEX=$((INDEX + 1))
          done

          # è¾“å‡ºæœ€ç»ˆç»Ÿè®¡
          echo "=========================================="
          echo "åŒæ­¥å®Œæˆç»Ÿè®¡"
          echo "=========================================="
          echo "æ€»æ•°æ®åº“æ•°: $TOTAL_DBS"
          echo "æˆåŠŸ: $SUCCESS_COUNT"
          echo "å¤±è´¥: $FAIL_COUNT"

          # å¦‚æœæœ‰å¤±è´¥çš„æ•°æ®åº“ï¼Œåˆ—å‡ºè¯¦æƒ…
          if [ $FAIL_COUNT -gt 0 ]; then
            echo ""
            echo "å¤±è´¥çš„æ•°æ®åº“:"
            for FAILED_DB in "${FAILED_DBS[@]}"; do
              echo "  - $FAILED_DB"
            done
            echo ""
            echo "=========================================="
            exit 1
          fi

          echo "=========================================="
          echo "âœ… æ‰€æœ‰æ•°æ®åº“åŒæ­¥æˆåŠŸï¼"
          echo "=========================================="

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT

      - name: Notify zilean to update submodule
        if: steps.sync.outputs.has_updates == 'true'
        run: |
          echo "ğŸ”” æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œé€šçŸ¥ zilean é¡¹ç›®æ›´æ–°å­æ¨¡å—..."
          curl -X POST https://api.github.com/repos/vitahlin/zilean/dispatches \
            -H "Authorization: token ${{ secrets.ZILEAN_AND_ANIVIA_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"event_type":"update_submodule_anivia"}'
          echo "âœ… é€šçŸ¥å·²å‘é€"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Notion åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

