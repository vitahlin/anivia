name: Sync Notion to Supabase

on:
  schedule:
    # æ¯ 3 å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
    - cron: '0 */3 * * *'

  push:
    branches:
      - main

  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      days:
        description: 'åŒæ­¥æœ€è¿‘å¤šå°‘å¤©çš„é¡µé¢ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤çš„3å°æ—¶ï¼‰'
        required: false
        type: string
        default: ''
      ignoreUpdateTime:
        description: 'å¿½ç•¥æ›´æ–°æ—¶é—´æ£€æŸ¥ï¼Œå¼ºåˆ¶åŒæ­¥æ‰€æœ‰é¡µé¢'
        required: false
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build project
        run: bun run build

      - name: Calculate time range
        id: time
        run: |
          # è·å–å½“å‰ UTC æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
          UTC_TIMESTAMP=$(date -u +%s)

          # åŠ  8 å°æ—¶ï¼ˆ28800 ç§’ï¼‰å¾—åˆ°åŒ—äº¬æ—¶é—´æˆ³
          BEIJING_TIMESTAMP=$((UTC_TIMESTAMP + 28800))

          # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´æ ¼å¼
          END_TIME=$(date -u -d "@$BEIJING_TIMESTAMP" +"%Y%m%d%H%M%S")

          # åˆ¤æ–­æ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æœ‰è¾“å…¥å¤©æ•°ï¼Œè¿˜æ˜¯å®šæ—¶è§¦å‘ï¼ˆé»˜è®¤3å°æ—¶ï¼‰
          DAYS="${{ github.event.inputs.days }}"

          if [ -n "$DAYS" ] && [ "$DAYS" != "0" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šåŒæ­¥æœ€è¿‘ N å¤©
            SECONDS_AGO=$((DAYS * 86400))  # å¤©æ•°è½¬æ¢ä¸ºç§’ï¼ˆ1å¤© = 86400ç§’ï¼‰
            START_TIMESTAMP=$((BEIJING_TIMESTAMP - SECONDS_AGO))
            START_TIME=$(date -u -d "@$START_TIMESTAMP" +"%Y%m%d%H%M%S")
            echo "ğŸ“… æ‰‹åŠ¨è§¦å‘ï¼šåŒæ­¥æœ€è¿‘ $DAYS å¤©çš„é¡µé¢"
          else
            # å®šæ—¶è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘ä½†æœªè¾“å…¥å¤©æ•°ï¼šé»˜è®¤ 3 å°æ—¶
            START_TIMESTAMP=$((BEIJING_TIMESTAMP - 10800))  # 3å°æ—¶ = 10800ç§’
            START_TIME=$(date -u -d "@$START_TIMESTAMP" +"%Y%m%d%H%M%S")
            echo "â° å®šæ—¶è§¦å‘ï¼šåŒæ­¥æœ€è¿‘ 3 å°æ—¶çš„é¡µé¢"
          fi

          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "end_time=$END_TIME" >> $GITHUB_OUTPUT

          echo "Time range (Beijing Time): $START_TIME to $END_TIME"

      - name: Sync Notion databases
        id: sync
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ZILEAN_CLOUDFLARE_R2_ACCESS_KEY: ${{ secrets.ZILEAN_CLOUDFLARE_R2_ACCESS_KEY }}
          ZILEAN_CLOUDFLARE_R2_SECRET_KEY: ${{ secrets.ZILEAN_CLOUDFLARE_R2_SECRET_KEY }}
          NOTION_DATABASE_IDS: ${{ vars.NOTION_DATABASE_IDS }}
        run: |
          # ä»ç¯å¢ƒå˜é‡è¯»å–æ•°æ®åº“ ID åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
          # ä¾‹å¦‚ï¼šNOTION_DATABASE_IDS="id1,id2,id3"

          if [ -z "$NOTION_DATABASE_IDS" ]; then
            echo "::error::NOTION_DATABASE_IDS æœªé…ç½®"
            exit 1
          fi

          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
          IFS=',' read -ra DATABASES <<< "$NOTION_DATABASE_IDS"

          START_TIME="${{ steps.time.outputs.start_time }}"
          END_TIME="${{ steps.time.outputs.end_time }}"
          IGNORE_UPDATE_TIME="${{ github.event.inputs.ignoreUpdateTime }}"

          echo "=========================================="
          echo "å¼€å§‹åŒæ­¥ Notion æ•°æ®åº“"
          echo "æ—¶é—´èŒƒå›´: $START_TIME - $END_TIME"
          echo "æ•°æ®åº“æ•°é‡: ${#DATABASES[@]}"
          if [ "$IGNORE_UPDATE_TIME" = "true" ]; then
            echo "âš ï¸  å¿½ç•¥æ›´æ–°æ—¶é—´æ£€æŸ¥: æ˜¯"
          fi
          echo "=========================================="
          echo ""

          # ç»Ÿè®¡å˜é‡
          TOTAL_DBS=${#DATABASES[@]}
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          FAILED_DBS=()
          HAS_UPDATES=false

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºæ”¶é›†æ¯ä¸ªæ•°æ®åº“çš„ has_updates çŠ¶æ€
          TEMP_OUTPUT_FILE=$(mktemp)

          # éå†æ‰€æœ‰æ•°æ®åº“
          INDEX=1
          for DB_ID in "${DATABASES[@]}"; do
            # å»é™¤ç©ºæ ¼
            DB_ID=$(echo "$DB_ID" | xargs)

            if [ -z "$DB_ID" ]; then
              continue
            fi

            echo "=========================================="
            echo "[$INDEX/$TOTAL_DBS] åŒæ­¥æ•°æ®åº“"
            echo "æ•°æ®åº“ ID: $DB_ID"
            echo "=========================================="

            # æ„å»ºåŒæ­¥å‘½ä»¤
            # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ”¶é›†æ¯ä¸ªæ•°æ®åº“çš„è¾“å‡º
            SYNC_CMD="GITHUB_OUTPUT=\"$TEMP_OUTPUT_FILE\" bun run dist/index.js sync-updated-page \"$DB_ID\" \"$START_TIME\" \"$END_TIME\""
            if [ "$IGNORE_UPDATE_TIME" = "true" ]; then
              SYNC_CMD="$SYNC_CMD --ignore-update-time"
            fi

            # æ‰§è¡ŒåŒæ­¥å‘½ä»¤å¹¶æ•è·è¾“å‡º
            SYNC_OUTPUT=$(eval $SYNC_CMD 2>&1)
            SYNC_EXIT_CODE=$?

            echo "$SYNC_OUTPUT"

            if [ $SYNC_EXIT_CODE -eq 0 ]; then
              echo "âœ… æ•°æ®åº“åŒæ­¥æˆåŠŸ"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))

              # æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ has_updates=true
              if grep -q "has_updates=true" "$TEMP_OUTPUT_FILE"; then
                HAS_UPDATES=true
                echo "ğŸ”” æ£€æµ‹åˆ°æ­¤æ•°æ®åº“æœ‰æ•°æ®æ›´æ–°"
              fi

              # æ¸…ç©ºä¸´æ—¶æ–‡ä»¶ï¼Œä¸ºä¸‹ä¸€ä¸ªæ•°æ®åº“åšå‡†å¤‡
              > "$TEMP_OUTPUT_FILE"
            else
              echo "âŒ æ•°æ®åº“åŒæ­¥å¤±è´¥"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              FAILED_DBS+=("$DB_ID")
            fi

            echo ""
            INDEX=$((INDEX + 1))
          done

          # è¾“å‡ºæœ€ç»ˆç»Ÿè®¡
          echo "=========================================="
          echo "åŒæ­¥å®Œæˆç»Ÿè®¡"
          echo "=========================================="
          echo "æ€»æ•°æ®åº“æ•°: $TOTAL_DBS"
          echo "æˆåŠŸ: $SUCCESS_COUNT"
          echo "å¤±è´¥: $FAIL_COUNT"

          # å¦‚æœæœ‰å¤±è´¥çš„æ•°æ®åº“ï¼Œåˆ—å‡ºè¯¦æƒ…
          if [ $FAIL_COUNT -gt 0 ]; then
            echo ""
            echo "å¤±è´¥çš„æ•°æ®åº“:"
            for FAILED_DB in "${FAILED_DBS[@]}"; do
              echo "  - $FAILED_DB"
            done
            echo ""
            echo "=========================================="
            exit 1
          fi

          echo "=========================================="
          echo "âœ… æ‰€æœ‰æ•°æ®åº“åŒæ­¥æˆåŠŸï¼"
          echo "=========================================="

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$TEMP_OUTPUT_FILE"

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€: has_updates=$HAS_UPDATES"

      - name: Notify zilean to update submodule (data updated)
        if: steps.sync.outputs.has_updates == 'true'
        run: |
          echo "ğŸ”” æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œé€šçŸ¥ zilean é¡¹ç›®æ›´æ–°å­æ¨¡å—..."
          curl -X POST https://api.github.com/repos/vitahlin/zilean/dispatches \
            -H "Authorization: token ${{ secrets.ZILEAN_AND_ANIVIA_GIT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"event_type":"update_submodule_anivia"}'
          echo "âœ… é€šçŸ¥å·²å‘é€"

      - name: Notify zilean to update submodule (main push)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ”” æ£€æµ‹åˆ° main åˆ†æ”¯æœ‰æ–°æäº¤ï¼Œé€šçŸ¥ zilean é¡¹ç›®æ›´æ–°å­æ¨¡å—..."
          curl -X POST https://api.github.com/repos/vitahlin/zilean/dispatches \
            -H "Authorization: token ${{ secrets.ZILEAN_AND_ANIVIA_GIT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"event_type":"update_submodule_anivia"}'
          echo "âœ… é€šçŸ¥å·²å‘é€"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Notion åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

